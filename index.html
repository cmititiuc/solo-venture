<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Against the Chaos Hordes</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    svg { border: 1px solid teal; }
    .tile {
      fill: #ffffff;
      fill-opacity: 1;
      stroke: #cfcfcf;
      stroke-width: 1;
      stroke-linecap: butt;
      stroke-linejoin: miter;
      stroke-miterlimit: 4;
      stroke-opacity: 1;
      stroke-dasharray: none;
      stroke-dashoffset: 0;
      display: inline;
    }
    .tile:hover {
      stroke: #ff0000;
      fill: #ffcccc;
    }
    .room {
      fill: none;
      stroke: black;
      stroke-width: 2;
    }
    circle:hover {
      stroke: #000099;
      fill-opacity: 1;
      fill: #CCCCFF;
    }
  </style>
  <script>
    var map = [
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1 ],
      [ 1, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 4, 2, 3, 3, 4, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 1, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 0, 0, 0 ]
    ];

    var viewportWidth, viewportHeight;
    var tileWidth = 30, tileHeight = 30;

    function coord(axis, value) {
      if (axis == "x") {
        return (viewportWidth / 2 - tileWidth * (map[0].length / 2) + (tileWidth + 1) * value);
      } else if (axis == "y") {
        return (viewportHeight / 2 - tileHeight * (map.length / 2) + (tileHeight + 1) * value);
      } else {
        console.log("Axis " + axis + "not recognized.");
      }
    }

    function makeRectangle(x, y) {
      var svgns = "http://www.w3.org/2000/svg";
      var svgDocument = document.getElementById('viewport').ownerDocument;

      var shape = svgDocument.createElementNS(svgns, "rect");
      shape.setAttributeNS(null, "x", coord('x', x));
      shape.setAttributeNS(null, "y", coord('y', y));
      shape.setAttributeNS(null, "width",  tileWidth);
      shape.setAttributeNS(null, "height", tileHeight);
      shape.setAttributeNS(null, "class", "tile");
      shape.setAttributeNS(null, "id", "tile-" + x + "-" + y);
      
      document.getElementById('viewport').appendChild(shape);
    }

    function makeRoom(x1, y1, x2, y2) {
      var svgns = "http://www.w3.org/2000/svg";
      var svgDocument = document.getElementById('viewport').ownerDocument;

      var shape = svgDocument.createElementNS(svgns, "rect");
      shape.setAttributeNS(null, "x", coord('x', Math.min(x1, x2)));
      shape.setAttributeNS(null, "y", coord('y', Math.min(y1, y2)));
      shape.setAttributeNS(null, "width",
        (Math.abs(x1 - x2) + 1) * (tileWidth + 1) - 1);
      shape.setAttributeNS(null, "height",
        (Math.abs(y1 - y2) + 1) * (tileHeight + 1) - 1);
      shape.setAttributeNS(null, "class", "room");
      // shape.setAttributeNS(null, "id", "");
      
      document.getElementById('viewport').appendChild(shape);
      // set data-room attributes for all tiles in the room
      var id = 'room-' + x1 + '-' + y1 + '-' + x2 + '-' + y2;
      for (var i = Math.min(x1, x2); i <= Math.max(x1, x2); i++) {
        for (var j = Math.min(y1, y2); j <= Math.max(y1, y2); j++) {
          document.getElementById('tile-' + i + '-' + j).setAttribute('data-room', id);
        }
      }
    }

    function makeUnit(x, y) {
      var svgns = "http://www.w3.org/2000/svg";
      var svgDocument = document.getElementById('viewport').ownerDocument;
      var targetTile = document.getElementById('tile-' + x + '-' + y);
      var cx = targetTile.x.baseVal.value;
      var cy = targetTile.y.baseVal.value;

      var shape = svgDocument.createElementNS(svgns, "circle");
      shape.setAttributeNS(null, "cx", cx + tileWidth / 2);
      shape.setAttributeNS(null, "cy", cy + tileHeight / 2);
      shape.setAttributeNS(null, "r", "10");
      shape.setAttributeNS(null, "fill-opacity", "1");
      shape.setAttributeNS(null, "fill", '#c66666');
      shape.setAttributeNS(null, "stroke-width", "2");
      shape.setAttributeNS(null, "stroke", "maroon");
      // shape.setAttributeNS(null, "class", "");
      shape.setAttributeNS(null, "id", "player");

      document.getElementById('viewport').appendChild(shape);
    }

    function makeDoor(x1, y1, x2, y2, state = 'closed') {
      // TODO: test to make sure tiles are adjacent
      var svgns = "http://www.w3.org/2000/svg";
      var svgDocument = document.getElementById('viewport').ownerDocument;
      var orientation = 'horizontal';
      if (y1 == y2) orientation = 'vertical';

      if (x1 == x2) {
        var temp = Math.min(y1, y2);
        var y2 = Math.max(y1, y2);
        y1 = temp;
      } else {
        var temp = Math.min(x1, x2);
        var x2 = Math.max(x1, x2);
        x1 = temp;
      }

      var shape = svgDocument.createElementNS(svgns, "line");
      if (orientation == 'horizontal') {
        shape.setAttributeNS(null, "x1", coord('x', x1));
        shape.setAttributeNS(null, "y1", coord('y', Math.max(y1, y2)));
        shape.setAttributeNS(null, "x2", coord('x', x1) + tileWidth);
        shape.setAttributeNS(null, "y2", coord('y', Math.max(y1, y2)));
      } else {
        shape.setAttributeNS(null, "x1", coord('x', Math.max(x1, x2)));
        shape.setAttributeNS(null, "y1", coord('y', y1));
        shape.setAttributeNS(null, "x2", coord('x', Math.max(x1, x2)));
        shape.setAttributeNS(null, "y2", coord('y', y1) + tileHeight);
      }
      shape.setAttributeNS(null, "stroke-width", "4");
      shape.setAttributeNS(null, "data-state", state);
      shape.setAttributeNS(null, "class", "door");
      shape.setAttributeNS(null, "id", "door-" + x1 + '-' + y1 + '-' + x2 + '-' + y2);
      if (state == 'open')
        shape.setAttributeNS(null, "stroke", "green");
      else
        shape.setAttributeNS(null, "stroke", "red");

      document.getElementById('viewport').appendChild(shape);
    }

    // do these two tiles have a door between them?
    function hasDoorBetween(x1, y1, x2, y2) {
      return document.getElementById('door-' + x1 + '-' + y1 + '-' + x2 + '-' + y2);
    }

    function openDoorBetween(x1, y1, x2, y2) {
      if (x1 == x2) {
        var temp = Math.min(y1, y2);
        var y2 = Math.max(y1, y2);
        y1 = temp;
      } else {
        var temp = Math.min(x1, x2);
        var x2 = Math.max(x1, x2);
        x1 = temp;
      }
      var door = document.getElementById('door-' + x1 + '-' + y1 + '-' + x2 + '-' + y2);
      if (door && door.getAttribute('data-state') == 'open')
        return true;
      else
        return false;
    }

    function moveUnit(id, x, y) {
      var unit = document.getElementById(id);
      var targetTile = document.getElementById('tile-' + x + '-' + y);
      var cx = targetTile.x.baseVal.value;
      var cy = targetTile.y.baseVal.value;
      unit.setAttributeNS(null, "cx", cx + tileWidth / 2);
      unit.setAttributeNS(null, "cy", cy + tileHeight / 2);
    }

    // from en.wikipedia.org/wiki/Breadth-first_search#Pseudocode
    function bfs(x, y) {
      var targetTile = document.getElementById('tile-' + x + '-' + y);
      var q = [], id;
      q.push([x, y]);
      targetTile.style.stroke = "green";
      targetTile.style.fill = "#CCFFCC";
      while(q.length !== 0) {
        var v = q.shift();
        targetTile = document.getElementById('tile-' + v[0] + '-' + v[1]);
        // north
        id = 'tile-' + v[0] + '-' + (v[1] - 1);
        if (targetTile = document.getElementById(id)) {
          if (targetTile.style.stroke !== "green") {
            q.push([v[0], v[1] - 1]);
            targetTile.style.stroke = "green";
            targetTile.style.fill = "#CCFFCC";
          }
        }
        // south
        id = 'tile-' + v[0] + '-' + (v[1] + 1);
        if (targetTile = document.getElementById(id)) {
          if (targetTile.style.stroke !== "green") {
            q.push([v[0], v[1] + 1]);
            targetTile.style.stroke = "green";
            targetTile.style.fill = "#CCFFCC";
          }
        }
        // east
        id = 'tile-' + (v[0] + 1) + '-' + v[1];
        if (targetTile = document.getElementById(id)) {
          if (targetTile.style.stroke !== "green") {
            q.push([v[0] + 1, v[1]]);
            targetTile.style.stroke = "green";
            targetTile.style.fill = "#CCFFCC";
          }
        }
        // west
        id = 'tile-' + (v[0] - 1) + '-' + v[1];
        if (targetTile = document.getElementById(id)) {
          if (targetTile.style.stroke !== "green") {
            q.push([v[0] - 1, v[1]]);
            targetTile.style.stroke = "green";
            targetTile.style.fill = "#CCFFCC";
          }
        }
      }
    }

    // slowed down version of bfs with range
    function bfsSlow(x, y, range = 5) {
      var targetTile = document.getElementById('tile-' + x + '-' + y);
      var q = [];
      q.push([x, y, 0]);
      targetTile.style.stroke = "green";
      targetTile.style.fill = "#CCFFCC";
      (function step() {
        if (q.length !== 0) {
          var v = q.shift(), id;
          // north
          id = 'tile-' + v[0] + '-' + (v[1] - 1);
          if (targetTile = document.getElementById(id)) {
            if (targetTile.style.stroke !== "green" && v[2] < range) {
              q.push([v[0], v[1] - 1, v[2] + 1]);
              targetTile.style.stroke = "green";
              targetTile.style.fill = "#CCFFCC";
            }
          }
          // south
          id = 'tile-' + v[0] + '-' + (v[1] + 1);
          if (targetTile = document.getElementById(id)) {
            if (targetTile.style.stroke !== "green" && v[2] < range) {
              q.push([v[0], v[1] + 1, v[2] + 1]);
              targetTile.style.stroke = "green";
              targetTile.style.fill = "#CCFFCC";
            }
          }
          // east
          id = 'tile-' + (v[0] + 1) + '-' + v[1];
          if (targetTile = document.getElementById(id)) {
            if (targetTile.style.stroke !== "green" && v[2] < range) {
              q.push([v[0] + 1, v[1], v[2] + 1]);
              targetTile.style.stroke = "green";
              targetTile.style.fill = "#CCFFCC";
            }
          }
          // west
          id = 'tile-' + (v[0] - 1) + '-' + v[1];
          if (targetTile = document.getElementById(id)) {
            if (targetTile.style.stroke !== "green" && v[2] < range) {
              q.push([v[0] - 1, v[1], v[2] + 1]);
              targetTile.style.stroke = "green";
              targetTile.style.fill = "#CCFFCC";
            }
          }
          setTimeout(step, 250);
        }
      })();
    }

    function drawShortestPath(x1, y1, x2, y2) {
      makeUnit(x1, y1);
      makeUnit(x2, y2);
      var targetTile = document.getElementById('tile-' + x1 + '-' + y1);
      var q = [];
      var found = false;
      q.push([x1, y1, []]);
      targetTile.style.stroke = "green";
      targetTile.style.fill = "#CCFFCC";
      // (function step() {
        // if (q.length !== 0) {
        while (q.length !== 0) {
          var v = q.shift(), id;
          function find(x, y) {
            if (x == x2 && y == y2) {
              found = true;
              q = []; // only need if running as while loop
              for (var i = 0; i < v[2].length; i++) {
                var id = 'tile-' + v[2][i][0] + '-' + v[2][i][1];
                targetTile = document.getElementById(id);
                targetTile.style.stroke = "blue";
                targetTile.style.fill = "#CCCCFF";
              }
              var id = 'tile-' + x2 + '-' + y2;
              targetTile = document.getElementById(id);
              targetTile.style.stroke = "blue";
              targetTile.style.fill = "#CCCCFF";
              var id = 'tile-' + v[0] + '-' + v[1];
              targetTile = document.getElementById(id);
              targetTile.style.stroke = "blue";
              targetTile.style.fill = "#CCCCFF";
            }
          }
          // north
          id = 'tile-' + v[0] + '-' + (v[1] - 1);
          if (targetTile = document.getElementById(id)) {
            id = 'tile-' + v[0] + '-' + v[1];
            if (document.getElementById(id).getAttribute('data-room') == targetTile.getAttribute('data-room') || openDoorBetween(v[0], v[1], v[0], v[1] - 1)) {
              find(v[0], v[1] - 1);
              if (targetTile.style.stroke !== "green" && found == false) {
                var h = [].concat(v[2]);
                h.push([ v[0], v[1] ]);
                q.push([ v[0], v[1] - 1, h ]);
                targetTile.style.stroke = "green";
                targetTile.style.fill = "#CCFFCC";
              }
            }
          }
          // south
          id = 'tile-' + v[0] + '-' + (v[1] + 1);
          if (targetTile = document.getElementById(id)) {
            id = 'tile-' + v[0] + '-' + v[1];
            if (document.getElementById(id).getAttribute('data-room') == targetTile.getAttribute('data-room') || openDoorBetween(v[0], v[1], v[0], v[1] + 1)) {
              find(v[0], v[1] + 1);
              if (targetTile.style.stroke !== "green" && found == false) {
                var h = [].concat(v[2]);
                h.push([ v[0], v[1] ]);
                q.push([v[0], v[1] + 1, h ]);
                targetTile.style.stroke = "green";
                targetTile.style.fill = "#CCFFCC";
              }
            }
          }
          // east
          id = 'tile-' + (v[0] + 1) + '-' + v[1];
          if (targetTile = document.getElementById(id)) {
            id = 'tile-' + v[0] + '-' + v[1];
            if (document.getElementById(id).getAttribute('data-room') == targetTile.getAttribute('data-room') || openDoorBetween(v[0], v[1], v[0] + 1, v[1])) {
              find(v[0] + 1, v[1]);
              if (targetTile.style.stroke !== "green" && found == false) {
                var h = [].concat(v[2]);
                h.push([ v[0], v[1] ]);
                q.push([v[0] + 1, v[1], h ]);
                targetTile.style.stroke = "green";
                targetTile.style.fill = "#CCFFCC";
              }
            }
          }
          // west
          id = 'tile-' + (v[0] - 1) + '-' + v[1];
          if (targetTile = document.getElementById(id)) {
            id = 'tile-' + v[0] + '-' + v[1];
            if (document.getElementById(id).getAttribute('data-room') == targetTile.getAttribute('data-room') || openDoorBetween(v[0], v[1], v[0] - 1, v[1])) {
              find(v[0] - 1, v[1]);
              if (targetTile.style.stroke !== "green" && found == false) {
                var h = [].concat(v[2]);
                h.push([ v[0], v[1] ]);
                q.push([v[0] - 1, v[1], h ]);
                targetTile.style.stroke = "green";
                targetTile.style.fill = "#CCFFCC";
              }
            }
          }
          // if (found == false) setTimeout(step, 1);
        }
      // })();
    }

    function init() {
      var viewport = document.getElementById('viewport');
      viewportWidth = viewport.width.baseVal.value;
      viewportHeight = viewport.height.baseVal.value;
      
      // draw tiles
      for (var i = 0; i < map.length; i++) {
        for (var j = 0; j < map[0].length; j++) {
          if (map[i][j] != 0) {
            makeRectangle(j, i);
          }
        }
      }
      
      // draw player
      makeUnit(0, 0);
      // makeRoom(1, 12, 4, 15);
      // makeRoom(8, 15, 5, 11);
      makeRoom(1, 13, 3, 15);
      makeRoom(7, 15, 5, 13);
      makeDoor(0, 14, 1, 14);
      makeDoor(4, 14, 5, 14);
      makeDoor(7, 15, 7, 16, 'open');
      makeDoor(6, 13, 6, 12);
      makeDoor(8, 14, 7, 14);

      // drawShortestPath(0, 15, 1, 13);
      drawShortestPath(6, 14, 16, 4);

      var tiles = document.getElementsByClassName('tile');
      for (var i = 0; i < tiles.length; i++) {
        tiles[i].addEventListener('click', function() {
          var x = this.id.match(/[0-9]+/);
          var y = this.id.match(/[0-9]+$/);
          console.log('x: ' + x + ' y: ' + y);
          moveUnit('player', x, y);
        }, false);
      }
    }
  </script>
</head>

<body onload="init();">

  <!--[if lt IE 8]>
  <p class="browserupgrade">
    You are using an <strong>outdated</strong> browser. Please
    <a href="http://browsehappy.com/">upgrade your browser</a> to improve your
    experience.</p>
  <![endif]-->

  <p>Against the Chaos Hordes</p>

  <svg id="viewport"
       xmlns:xlink="http://www.w3.org/2000/svg"
       version="1.1"
       width="800"
       height="600">
  </svg>

</body>

</html>
