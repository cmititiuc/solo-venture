<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Against the Chaos Hordes</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="main.css">
  <script src="javascript.js"></script>
  <script>
    var map = [
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1 ],
      [ 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1 ],
      [ 1, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 2, 2, 3, 3, 3, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 2, 2, 4, 2, 3, 3, 4, 3, 0, 0, 0, 1, 1, 0, 0, 0 ],
      [ 1, 1, 1, 4, 1, 1, 1, 4, 1, 1, 1, 1, 1, 1, 0, 0, 0 ]
    ];

    var viewportWidth, viewportHeight;
    var tileWidth = 30, tileHeight = 30;

    function doorBetween(x1, y1, x2, y2, state) {
      if (x1 == x2) {
        var temp = Math.min(y1, y2);
        var y2 = Math.max(y1, y2);
        y1 = temp;
      } else {
        var temp = Math.min(x1, x2);
        var x2 = Math.max(x1, x2);
        x1 = temp;
      }
      var id = 'door-' + x1 + '-' + y1 + '-' + x2 + '-' + y2;
      var door = document.getElementById(id);
      if (door && door.getAttribute('data-state') == state)
        return true;
      else
        return false;
    }

    function drawShortestPath(x1, y1, x2, y2) {
      makeMark(x1, y1);
      makeMark(x2, y2);
      var source = document.getElementById('tile-' + x1 + '-' + y1);
      source.setAttribute('class', 'probed');
      var q = [];
      var found = false;
      q.push([x1, y1, []]);

      function markTile(x, y, className) {
        var id = 'tile-' + x + '-' + y;
        var target = document.getElementById(id);
        target.setAttribute('class', className);
      }

      function find(x, y) {
        if (x == x2 && y == y2) {
          found = true;
          q = []; // only need if running as while loop
          for (var i = 0; i < v[2].length; i++) {
            markTile(v[2][i][0], v[2][i][1], 'path');
          }
          markTile(x2, y2, 'path');
          markTile(v[0], v[1], 'path');
        }
      }

      function probe(v, x, y) {
        var node = document.getElementById('tile-' + v[0] + '-' + v[1]);
        var target = document.getElementById('tile-' + x + '-' + y);
        if (target && !doorBetween(v[0], v[1], x, y, 'closed')) {
          if (sameRoom(node, target) || doorBetween(v[0], v[1], x, y, 'open')) {
            find(x, y);
            if (found == false && target.getAttribute('class') !== "probed") {
              var history = v[2].slice();
              history.push([ v[0], v[1] ]);
              q.push([ x, y, history ]);
              target.setAttribute('class', 'probed');
            }
          }
        }
      }

      // (function step() {
        // if (q.length !== 0) {
        while (q.length !== 0) {
          var v = q.shift(), id;
          var id = 'tile-' + v[0] + '-' + v[1];
          var node = document.getElementById(id);

          probe(v, v[0]    , v[1] - 1); // north
          probe(v, v[0]    , v[1] + 1); // south
          probe(v, v[0] + 1, v[1]    ); // east
          probe(v, v[0] - 1, v[1]    ); // west

          // if (found == false) setTimeout(step, 1);
        }
      // })();
    }

    function init() {
      var viewport = document.getElementById('viewport');
      viewportWidth = viewport.width.baseVal.value;
      viewportHeight = viewport.height.baseVal.value;
      
      // draw tiles
      for (var i = 0; i < map.length; i++) {
        for (var j = 0; j < map[0].length; j++) {
          if (map[i][j] != 0) {
            makeRectangle(j, i);
          }
        }
      }
      
      var tiles = document.getElementsByClassName('tile');
      for (var i = 0; i < tiles.length; i++) {
        tiles[i].addEventListener('click', function() {
          var x = this.id.match(/[0-9]+/);
          var y = this.id.match(/[0-9]+$/);
          console.log('x: ' + x + ' y: ' + y);
          moveUnit('player', x, y);
        }, false);
      }

      // draw player
      makeUnit(0, 0);
      // makeRoom(1, 12, 4, 15);
      // makeRoom(8, 15, 5, 11);
      makeRoom(1, 13, 3, 15);
      makeRoom(7, 15, 5, 13);
      makeDoor(0, 14, 1, 14);
      makeDoor(4, 14, 5, 14);
      makeDoor(7, 15, 7, 16);
      makeDoor(6, 13, 6, 12);
      makeDoor(8, 14, 7, 14, 'open');
      makeDoor(8, 16, 9, 16, 'open');


      // drawShortestPath(0, 15, 1, 13);
      drawShortestPath(6, 14, 9, 10);
    }
  </script>
</head>

<body onload="init();">

  <!--[if lt IE 8]>
  <p class="browserupgrade">
    You are using an <strong>outdated</strong> browser. Please
    <a href="http://browsehappy.com/">upgrade your browser</a> to improve your
    experience.</p>
  <![endif]-->

  <p>Against the Chaos Hordes</p>

  <svg id="viewport"
       xmlns:xlink="http://www.w3.org/2000/svg"
       version="1.1"
       width="800"
       height="600">
  </svg>

</body>

</html>
