<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Against the Chaos Hordes</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="main.css">
  <script src="javascript.js"></script>
  <script>
    var map = [];
    var map1 = [
      "10000000000000000",
      "10000000000000000",
      "10000000000000000",
      "10000000000000000",
      "10000000011111111",
      "10000000010000001",
      "10000000010000001",
      "11111111110000001",
      "10000000010000001",
      "10000000010000001",
      "10000000011111111",
      "10000111100011000",
      "11111111100011000",
      "11111111100011000",
      "11111111100011000",
      "11111111100011000",
      "11111111111111000"
    ];

    var map2 = [
      "011111111111000000",
      "111111111111000000",
      "111111111111000000",
      "111111111111000000",
      "111111111111000000",
      "111111111111111110",
      "111111111111111110",
      "111111111111111110",
      "111111111111111110",
      "111110000111111110",
      "111110000111111110",
      "111110000111111110",
      "111111111111111111",
      "111111111111111111",
      "111111111111111111",
      "111111111111111111",
      "111111111111111111",
      "111111111111110000"
    ];

    var selected_map = map2;
    for (var i = 0; i < selected_map.length; i++) {
      var row = [];
      for (var j = 0; j < selected_map[i].length; j++) {
        row.push(+selected_map[i][j]);
      }
      map.push(row);
    }
    // var map2 = JSON.parse("[" + "123" + "]");

    var viewportWidth, viewportHeight;
    var tileWidth = 30, tileHeight = 30;

    function doorBetween(x1, y1, x2, y2, state) {
      if (x1 == x2) {
        var temp = Math.min(y1, y2);
        var y2 = Math.max(y1, y2);
        y1 = temp;
      } else {
        var temp = Math.min(x1, x2);
        var x2 = Math.max(x1, x2);
        x1 = temp;
      }
      var id = 'door-' + x1 + '-' + y1 + '-' + x2 + '-' + y2;
      var door = document.getElementById(id);
      if (door && door.getAttribute('data-state') == state)
        return true;
      else
        return false;
    }

    function drawShortestPath(x1, y1, x2, y2) {
      // makeMark(x1, y1);
      // makeMark(x2, y2);
      var source = document.getElementById('tile-' + x1 + '-' + y1);
      source.setAttribute('class', 'probed');
      var q = [];
      var found = false;
      q.push([x1, y1, []]);
      probe([x1, y1, []], x1, y1);

      function probe(v, x, y) {
        function find(x, y) {
          if (x == x2 && y == y2) {
            found = true;
            q = []; // only need if running as while loop
            for (var i = 0; i < v[2].length; i++) {
              markTile(v[2][i][0], v[2][i][1], 'path');
            }
            markTile(x2, y2, 'path');
            markTile(v[0], v[1], 'path');
          }
        }

        var node = document.getElementById('tile-' + v[0] + '-' + v[1]);
        var target = document.getElementById('tile-' + x + '-' + y);
        if (target) {
          var occupied = target.getAttribute('data-occupied');
          occupied = occupied && occupied != 'friendly';
          if (!occupied && !doorBetween(v[0], v[1], x, y, 'closed')) {
            if (sameRoom(node, target) || doorBetween(v[0], v[1], x, y, 'open')) {
              find(x, y);
              if (found == false && target.getAttribute('class') !== "probed") {
                var history = v[2].slice();
                history.push([ v[0], v[1] ]);
                q.push([ x, y, history ]);
                target.setAttribute('class', 'probed');
              }
            }
          }
        }
      }

      // (function step() {
        // if (q.length !== 0) {
        while (q.length !== 0) {
          var v = q.shift();
          var id = 'tile-' + v[0] + '-' + v[1];
          var node = document.getElementById(id);

          probe(v, v[0]     , +v[1] - 1); // north
          probe(v, v[0]     , +v[1] + 1); // south
          probe(v, +v[0] + 1, v[1]     ); // east
          probe(v, +v[0] - 1, v[1]     ); // west

          // if (found == false) setTimeout(step, 1);
        }
      // })();
    }

    function init() {
      var viewport = document.getElementById('viewport');
      viewportWidth = viewport.width.baseVal.value;
      viewportHeight = viewport.height.baseVal.value;
      
      // draw tiles
      for (var i = 0; i < map.length; i++) {
        for (var j = 0; j < map[0].length; j++) {
          if (map[i][j] != 0) {
            makeRectangle(j, i);
          }
        }
      }
      
      var tiles = document.getElementsByClassName('tile');
      for (var i = 0; i < tiles.length; i++) {
        tiles[i].addEventListener('click', updateMap, false);
      }

      for (var i = 0; i < tiles.length; i++) {
        tiles[i].addEventListener('mouseover', function() {
          var player = document.getElementsByClassName('player')[0];
          var x1 = player.getAttribute('data-x');
          var y1 = player.getAttribute('data-y');
          var x2 = this.id.match(/[0-9]+/);
          var y2 = this.id.match(/[0-9]+$/);
          drawShortestPath(x1, y1, x2, y2);
        }, false);

        tiles[i].addEventListener('mouseout', function() {
          resetTiles();
        }, false);
      }

      makeRoom(1, 0, 4, 2);
      makeRoom(5, 0, 8, 2);
      makeRoom(9, 0, 11, 4);
      makeRoom(1, 9, 4, 12);
      makeRoom(1, 3, 4, 7);
      makeRoom(5, 3, 8, 7);
      makeRoom(1, 13, 4, 16);
      makeRoom(5, 12, 8, 16);
      makeRoom(9, 12, 11, 16);
      makeRoom(14, 12, 17, 16);
      makeRoom(10, 6, 15, 10);
      makeFurniture(10, 0, 11, 2);
      makeFurniture(10, 4, 10, 4);
      makeFurniture(1, 4, 2, 6);
      makeFurniture(6, 4, 8, 5);
      makeFurniture(3, 9, 4, 11);
      makeFurniture(5, 12, 7, 12);
      makeFurniture(5, 14, 6, 16);
      makeFurniture(11, 14, 11, 16);
      makeFurniture(15, 12, 17, 12);
      makeFurniture(15, 16, 17, 16);
      makeFurniture(17, 15, 17, 15);
      makeFurniture(11, 8, 13, 9);
      makeFurniture(12, 6, 14, 6);
      makeFurniture(11, 6, 11, 6);
      makeFurniture(10, 7, 10, 7);
      makeDoor(3, 2, 3, 3);
      makeDoor(4, 1, 5, 1);
      makeDoor(8, 1, 9, 1);
      makeDoor(3, 7, 3, 8);
      makeDoor(0, 10, 1, 10);
      makeDoor(3, 16, 3, 17);
      makeDoor(7, 16, 7, 17);
      makeDoor(8, 14, 9, 14);
      makeDoor(10, 11, 10, 12);
      makeDoor(13, 14, 14, 14);
      makeDoor(7, 7, 7, 8);
      makeDoor(16, 8, 15, 8);
      makeUnit(2, 14);
      makeUnit(1, 14);
      makeUnit(2, 1, 'foe');
      makeUnit(3, 1, 'foe');
      makeUnit(6, 0, 'foe');
      makeUnit(6, 1, 'foe');
      makeUnit(6, 2, 'foe');
      makeUnit(9, 0, 'foe');
      makeUnit(9, 2, 'foe');
      makeUnit(9, 3, 'foe');
      makeUnit(3, 5, 'foe');
      makeUnit(4, 4, 'foe');
      makeUnit(6, 6, 'foe');
      makeUnit(7, 6, 'foe');
      makeUnit(2, 10, 'foe');
      makeUnit(2, 11, 'foe');
      makeUnit(7, 13, 'foe');
      makeUnit(8, 14, 'foe');
      makeUnit(10, 13, 'foe');
      makeUnit(10, 15, 'foe');
      makeUnit(16, 14, 'foe');
      makeUnit(15, 15, 'foe');
      makeUnit(14, 7, 'foe');
      makeUnit(11, 10, 'foe');
      makeUnit(14, 10, 'foe');
      makeUnit(12, 7, 'foe');

      var doors = document.getElementsByClassName('door');
      for (var i = 0; i < doors.length; i++) {
        doors[i].addEventListener('click', function() {
          if (this.getAttribute('data-state') == 'open') {
            this.setAttribute('data-state', 'closed');
            this.style.stroke = 'red';
          } else {
            this.setAttribute('data-state', 'open');
            this.style.stroke = 'green';
          }
        }, false);
      }
    }
  </script>
</head>

<body onload="init();">

  <!--[if lt IE 8]>
  <p class="browserupgrade">
    You are using an <strong>outdated</strong> browser. Please
    <a href="http://browsehappy.com/">upgrade your browser</a> to improve your
    experience.</p>
  <![endif]-->

  <h1>Against the Chaos Hordes</h1>
  <h2>(or Savage Tales)</h2>

  <svg id="viewport"
       xmlns:xlink="http://www.w3.org/2000/svg"
       version="1.1"
       width="800"
       height="600">
  </svg>

</body>

</html>
